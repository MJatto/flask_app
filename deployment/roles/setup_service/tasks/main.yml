- include_role:
    name: copy_app

- name: Ensure virtual environment exists
  command: python3 -m venv /opt/flask-app/venv
  args:
    creates: /opt/flask-app/venv/bin/activate

- name: Install dependencies in the virtual environment
  pip:
    requirements: /opt/flask-app/requirements.txt
    virtualenv: /opt/flask-app/venv
    virtualenv_python: python3-pip

- name: Setup Services
  copy:
    dest: /etc/systemd/system/flask-app.service
    content: |
      [Unit]
      Description = Flask App
      After = network.target

      [Service]
      WorkingDirectory = /opt/flask-app
      Environment="PATH=/opt/flask-app/venv/bin"
      ExecStart = /opt/flask-app/venv/bin/python app.py
      Restart = always

      StandardOutput = append:/var/log/flask-app.log
      StandardError = append:/var/log/flask-error.log

      [Install]
      WantedBy = multi_user.target

- name: Reload System and Start FLask App
  systemd:
    daemon_reload: yes
    name: flask-app
    state: restarted
    enabled: yes